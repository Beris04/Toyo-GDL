<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Toyo ‚Äì Seguimiento de Visitas</title>
<meta name="theme-color" content="#0046BE">
<link rel="manifest" href="manifest.json">

<style>
:root{
  --blue:#0046BE; --bg:#F0F2F5; --card:#fff;
  --border:#d9dde6; --text:#0f172a; --muted:#64748b;
}
*{box-sizing:border-box}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);padding:14px;color:var(--text)}
.wrap{max-width:1100px;margin:auto}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:14px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
label{font-size:13px;color:var(--muted)}
select,input,textarea,button{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);font-size:16px}
textarea{min-height:90px}
.btn{background:var(--blue);color:#fff;font-weight:bold;border:none}
.btn2{background:#fff;color:var(--blue);font-weight:bold;border:1px solid var(--blue)}
.progress{height:14px;background:#e5e7eb;border-radius:999px;overflow:hidden}
.progress div{height:100%;background:linear-gradient(90deg,var(--blue),#2d7dff)}
.small{font-size:13px;color:var(--muted)}
hr{border:none;border-top:1px solid var(--border);margin:10px 0}
</style>
</head>

<body>
<div class="wrap">

<div class="card">
  <h2 style="margin:0;color:var(--blue)">Registro de Visitas</h2>
  <div class="small">Control diario con GPS</div>
</div>

<div class="grid">

<!-- CAPTURA -->
<div class="card">
<label>Vendedor</label>
<select id="vendedor"></select>

<label style="margin-top:10px">Cliente</label>
<input id="cliente">

<label style="margin-top:10px">Comentarios</label>
<textarea id="comentarios"></textarea>

<div class="small" id="gpsBox" style="margin-top:10px">GPS: sin capturar</div>

<button class="btn2" onclick="capturarGPS()">üìç Capturar GPS</button>
<button class="btn" onclick="guardar()">‚úÖ Guardar visita</button>
</div>

<!-- AVANCE -->
<div class="card">
<b id="pctDia">0%</b>
<div class="progress"><div id="barDia"></div></div>
<div class="small" id="subDia"></div>

<b id="pctSemana">0%</b>
<div class="progress"><div id="barSemana"></div></div>
<div class="small" id="subSemana"></div>

<hr>

<label>Meta mensual ($)</label>
<input id="meta">

<label>Venta del d√≠a ($)</label>
<input id="venta">

<button class="btn" onclick="guardarVenta()">üí∞ Guardar venta</button>

<b id="pctVenta">0%</b>
<div class="progress"><div id="barVenta"></div></div>
<div class="small" id="subVenta"></div>
</div>
</div>

<!-- HISTORIAL -->
<div class="card">
<h3>Historial</h3>
<button class="btn2" onclick="exportarPorVendedor()">üìä Descargar Excel por vendedor</button>
<div id="lista"></div>
</div>

</div>

<script>
/* ===== CONFIG ===== */
const META_DIA=5, META_SEM=25;
const LS="toyo_visitas", BACKUP="toyo_backup";
const YM=new Date().getFullYear()+"_"+(new Date().getMonth()+1);
const META_KEY="meta_"+YM, VENTAS_KEY="ventas_"+YM;

/* ===== VENDEDORES ===== */
const VENDEDORES=[
"Aguilar Neri Daniel","De la Cruz Ponce Julio Cesar","Garibay Ortiz Sergio Joel",
"Perez Mar Alan Roberto","Reynoso Aguilar Maricela","Sandra Navarro Navarro",
"Arcenio Aguirre Ojeda","Velez Castellanos Antonio","Yepez Mora Oscar Alberto",
"Hernandez Gonzalez Miguel Angel","Sierra de Anda Aldo"
];
VENDEDORES.forEach(v=>vendedor.add(new Option(v,v)));

let gps=null;

/* ===== FECHAS ===== */
const dayKey=()=>new Date().toISOString().slice(0,10);
const weekKey=()=>{
 const d=new Date(); d.setDate(d.getDate()+4-(d.getDay()||7));
 const y=new Date(d.getFullYear(),0,1);
 return d.getFullYear()+"-W"+Math.ceil((((d-y)/86400000)+1)/7);
};

/* ===== GPS ===== */
function capturarGPS(){
 navigator.geolocation.getCurrentPosition(p=>{
  gps=p.coords;
  gpsBox.textContent=`GPS: ${gps.latitude.toFixed(5)}, ${gps.longitude.toFixed(5)}`;
 });
}

/* ===== GUARDAR VISITA ===== */
function guardar(){
 if(!cliente.value||!gps) return alert("Cliente y GPS obligatorios");

 const data=JSON.parse(localStorage.getItem(LS)||"[]");
 const rec={
  vendedor:vendedor.value,
  cliente:cliente.value,
  comentarios:comentarios.value,
  gps,
  fecha:new Date().toISOString(),
  day:dayKey(),
  week:weekKey()
 };
 data.push(rec);

 localStorage.setItem(LS,JSON.stringify(data));
 localStorage.setItem(BACKUP,JSON.stringify(data)); // ‚òÅÔ∏è respaldo

 cliente.value=""; comentarios.value="";
 gps=null; gpsBox.textContent="GPS: sin capturar";
 render();
}

/* ===== RENDER ===== */
function render(){
 const d=JSON.parse(localStorage.getItem(LS)||"[]");
 lista.innerHTML="";
 d.slice().reverse().forEach(x=>{
  lista.innerHTML+=`
  <div class="small">
   <b>${x.vendedor}</b> ‚Äì ${x.cliente}<br>
   ${new Date(x.fecha).toLocaleString("es-MX")}<br>
   <a target="_blank" href="https://maps.google.com/?q=${x.gps.latitude},${x.gps.longitude}">üó∫Ô∏è Ver mapa</a>
  </div><hr>`;
 });
 renderAvance();
}

/* ===== AVANCE ===== */
function renderAvance(){
 const d=JSON.parse(localStorage.getItem(LS)||"[]");
 const h=d.filter(x=>x.day===dayKey()).length;
 const s=d.filter(x=>x.week===weekKey()).length;

 pctDia.textContent=Math.round(h/META_DIA*100)+"%";
 barDia.style.width=pctDia.textContent;
 subDia.textContent=`${h} de ${META_DIA} visitas hoy`;

 pctSemana.textContent=Math.round(s/META_SEM*100)+"%";
 barSemana.style.width=pctSemana.textContent;
 subSemana.textContent=`${s} de ${META_SEM} visitas semana`;
}

/* ===== VENTAS ===== */
function guardarVenta(){
 localStorage.setItem(META_KEY,meta.value);
 let v=JSON.parse(localStorage.getItem(VENTAS_KEY)||"[]");
 v.push(Number(venta.value||0));
 localStorage.setItem(VENTAS_KEY,JSON.stringify(v));
 venta.value="";
 renderVentas();
}
function renderVentas(){
 const m=Number(localStorage.getItem(META_KEY)||0);
 const v=JSON.parse(localStorage.getItem(VENTAS_KEY)||"[]");
 const t=v.reduce((a,b)=>a+b,0);
 const p=m?Math.round(t/m*100):0;
 pctVenta.textContent=p+"%";
 barVenta.style.width=p+"%";
 subVenta.textContent="$"+t+" de $"+m;
}

/* ===== EXCEL POR VENDEDOR ===== */
function exportarPorVendedor(){
 const d=JSON.parse(localStorage.getItem(LS)||"[]");
 const meta=localStorage.getItem(META_KEY)||0;
 const ventas=JSON.parse(localStorage.getItem(VENTAS_KEY)||"[]").reduce((a,b)=>a+b,0);
 const pctV=meta?Math.round(ventas/meta*100):0;

 VENDEDORES.forEach(v=>{
  const rows=d.filter(x=>x.vendedor===v);
  if(!rows.length) return;

  let csv=["Vendedor,Cliente,Comentarios,Fecha,Lat,Lng,Semana,%VisitasDia,%VisitasSemana,Meta,Ventas,%Ventas"];
  rows.forEach(x=>{
   csv.push([
    x.vendedor,x.cliente,
    `"${x.comentarios.replace(/"/g,'""')}"`,
    new Date(x.fecha).toLocaleString("es-MX"),
    x.gps.latitude,x.gps.longitude,
    x.week,pctDia.textContent,pctSemana.textContent,
    meta,ventas,pctV+"%"
   ].join(","));
  });

  const blob=new Blob([csv.join("\n")],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`reporte_${v.replace(/ /g,"_")}.csv`;
  a.click();
 });
}

render(); renderVentas();

/* ===== SW ===== */
if("serviceWorker"in navigator){
 navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>



